var BMapLib=window.BMapLib=BMapLib||{};!function(){function t(t){this._markerClusterer=t,this._map=t.getMap(),this._minClusterSize=t.getMinClusterSize(),this._isAverageCenter=t.isAverageCenter(),this._center=null,this._markers=[],this._gridBounds=null,this._isReal=!1,this._clusterMarker=new BMapLib.TextIconOverlay(this._center,this._markers.length,{styles:this._markerClusterer.getStyles()})}var e=function(t,e,s){e=r(e);var i=t.pointToPixel(e.getNorthEast()),a=t.pointToPixel(e.getSouthWest());i.x+=s,i.y-=s,a.x-=s,a.y+=s;var n=t.pixelToPoint(i),o=t.pixelToPoint(a);return new BMap.Bounds(o,n)},r=function(t){var e=s(t.getNorthEast().lng,-180,180),r=s(t.getSouthWest().lng,-180,180),i=s(t.getNorthEast().lat,-74,74),a=s(t.getSouthWest().lat,-74,74);return new BMap.Bounds(new BMap.Point(r,a),new BMap.Point(e,i))},s=function(t,e,r){return e&&(t=Math.max(t,e)),r&&(t=Math.min(t,r)),t},i=function(t){return"[object Array]"===Object.prototype.toString.call(t)},a=function(t,e){var r=-1;if(i(e))if(e.indexOf)r=e.indexOf(t);else for(var s,a=0;s=e[a];a++)if(s===t){r=a;break}return r},n=BMapLib.MarkerClusterer=function(t,e){if(t){this._map=t,this._markers=[],this._clusters=[];var r=e||{};this._gridSize=r.gridSize||60,this._maxZoom=r.maxZoom||18,this._minClusterSize=r.minClusterSize||2,this._isAverageCenter=!1,void 0!=r.isAverageCenter&&(this._isAverageCenter=r.isAverageCenter),this._styles=r.styles||[];var s=this;this._map.addEventListener("zoomend",function(){s._redraw()}),this._map.addEventListener("moveend",function(){s._redraw()});var a=r.markers;i(a)&&this.addMarkers(a)}};n.prototype.addMarkers=function(t){for(var e=0,r=t.length;r>e;e++)this._pushMarkerTo(t[e]);this._createClusters()},n.prototype._pushMarkerTo=function(t){var e=a(t,this._markers);-1===e&&(t.isInCluster=!1,this._markers.push(t))},n.prototype.addMarker=function(t){this._pushMarkerTo(t),this._createClusters()},n.prototype._createClusters=function(){for(var t,r=this._map.getBounds(),s=e(this._map,r,this._gridSize),i=0;t=this._markers[i];i++)!t.isInCluster&&s.containsPoint(t.getPosition())&&this._addToClosestCluster(t)},n.prototype._addToClosestCluster=function(e){for(var r,s=4e6,i=null,a=(e.getPosition(),0);r=this._clusters[a];a++){var n=r.getCenter();if(n){var o=this._map.getDistance(n,e.getPosition());s>o&&(s=o,i=r)}}if(i&&i.isMarkerInClusterBounds(e))i.addMarker(e);else{var r=new t(this);r.addMarker(e),this._clusters.push(r)}},n.prototype._clearLastClusters=function(){for(var t,e=0;t=this._clusters[e];e++)t.remove();this._clusters=[],this._removeMarkersFromCluster()},n.prototype._removeMarkersFromCluster=function(){for(var t,e=0;t=this._markers[e];e++)t.isInCluster=!1},n.prototype._removeMarkersFromMap=function(){for(var t,e=0;t=this._markers[e];e++)t.isInCluster=!1,tmplabel=t.getLabel(),this._map.removeOverlay(t),t.setLabel(tmplabel)},n.prototype._removeMarker=function(t){var e=a(t,this._markers);return-1===e?!1:(tmplabel=t.getLabel(),this._map.removeOverlay(t),t.setLabel(tmplabel),this._markers.splice(e,1),!0)},n.prototype.removeMarker=function(t){var e=this._removeMarker(t);return e&&(this._clearLastClusters(),this._createClusters()),e},n.prototype.removeMarkers=function(t){for(var e=!1,r=0;r<t.length;r++){var s=this._removeMarker(t[r]);e=e||s}return e&&(this._clearLastClusters(),this._createClusters()),e},n.prototype.clearMarkers=function(){this._clearLastClusters(),this._removeMarkersFromMap(),this._markers=[]},n.prototype._redraw=function(){this._clearLastClusters(),this._createClusters()},n.prototype.getGridSize=function(){return this._gridSize},n.prototype.setGridSize=function(t){this._gridSize=t,this._redraw()},n.prototype.getMaxZoom=function(){return this._maxZoom},n.prototype.setMaxZoom=function(t){this._maxZoom=t,this._redraw()},n.prototype.getStyles=function(){return this._styles},n.prototype.setStyles=function(t){this._styles=t,this._redraw()},n.prototype.getMinClusterSize=function(){return this._minClusterSize},n.prototype.setMinClusterSize=function(t){this._minClusterSize=t,this._redraw()},n.prototype.isAverageCenter=function(){return this._isAverageCenter},n.prototype.getMap=function(){return this._map},n.prototype.getMarkers=function(){return this._markers},n.prototype.getClustersCount=function(){for(var t,e=0,r=0;t=this._clusters[r];r++)t.isReal()&&e++;return e},t.prototype.addMarker=function(t){if(this.isMarkerInCluster(t))return!1;if(this._center){if(this._isAverageCenter){var e=this._markers.length+1,r=(this._center.lat*(e-1)+t.getPosition().lat)/e,s=(this._center.lng*(e-1)+t.getPosition().lng)/e;this._center=new BMap.Point(s,r),this.updateGridBounds()}}else this._center=t.getPosition(),this.updateGridBounds();t.isInCluster=!0,this._markers.push(t);var i=this._markers.length;if(i<this._minClusterSize)return this._map.addOverlay(t),!0;if(i===this._minClusterSize)for(var a=0;i>a;a++)tmplabel=this._markers[a].getLabel(),this._markers[a].getMap()&&this._map.removeOverlay(this._markers[a]),this._markers[a].setLabel(tmplabel);return this._map.addOverlay(this._clusterMarker),this._isReal=!0,this.updateClusterMarker(),!0},t.prototype.isMarkerInCluster=function(t){if(this._markers.indexOf)return-1!=this._markers.indexOf(t);for(var e,r=0;e=this._markers[r];r++)if(e===t)return!0;return!1},t.prototype.isMarkerInClusterBounds=function(t){return this._gridBounds.containsPoint(t.getPosition())},t.prototype.isReal=function(){return this._isReal},t.prototype.updateGridBounds=function(){var t=new BMap.Bounds(this._center,this._center);this._gridBounds=e(this._map,t,this._markerClusterer.getGridSize())},t.prototype.updateClusterMarker=function(){if(this._map.getZoom()>this._markerClusterer.getMaxZoom()){this._clusterMarker&&this._map.removeOverlay(this._clusterMarker);for(var t,e=0;t=this._markers[e];e++)this._map.addOverlay(t)}else{if(this._markers.length<this._minClusterSize)return this._clusterMarker.hide(),void 0;this._clusterMarker.setPosition(this._center),this._clusterMarker.setText(this._markers.length);var r=this._map,s=this.getBounds();this._clusterMarker.addEventListener("click",function(){r.setViewport(s)})}},t.prototype.remove=function(){for(var t,e=0;t=this._markers[e];e++){var r=this._markers[e].getLabel();this._markers[e].getMap()&&this._map.removeOverlay(this._markers[e]),this._markers[e].setLabel(r)}this._map.removeOverlay(this._clusterMarker),this._markers.length=0,delete this._markers},t.prototype.getBounds=function(){for(var t,e=new BMap.Bounds(this._center,this._center),r=0;t=this._markers[r];r++)e.extend(t.getPosition());return e},t.prototype.getCenter=function(){return this._center}}();